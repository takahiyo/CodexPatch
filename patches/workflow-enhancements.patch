diff --git a/.github/workflows/apply-batch-patches.yml b/.github/workflows/apply-batch-patches.yml
new file mode 100644
index 0000000..78ff738
--- /dev/null
+++ b/.github/workflows/apply-batch-patches.yml
@@ -0,0 +1,353 @@
+name: è¤‡æ•°ãƒ‘ãƒƒãƒã®ä¸€æ‹¬é©ç”¨
+
+on:
+  workflow_dispatch:
+    inputs:
+      target_repository:
+        description: 'ãƒ‘ãƒƒãƒã‚’é©ç”¨ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª (owner/name)ã€‚ç©ºæ¬„æ™‚ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒª'
+        required: false
+        default: ''
+      target_branch:
+        description: 'ãƒ‘ãƒƒãƒã‚’é©ç”¨ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒå'
+        required: true
+        default: 'main'
+      patch_files:
+        description: 'ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆï¼ˆæ”¹è¡Œã¾ãŸã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ä¾‹: patches/a.patch,patches/b.patchï¼‰'
+        required: true
+        default: ''
+      push_strategy:
+        description: 'direct: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ç›´æ¥ push / pull_request: ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ‡ã£ã¦ PR ä½œæˆ'
+        required: true
+        type: choice
+        default: 'pull_request'
+        options:
+          - pull_request
+          - direct
+      commit_message:
+        description: 'ä½œæˆã™ã‚‹ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
+        required: true
+        default: 'Apply multiple Codex patches'
+      pr_title:
+        description: 'PR ã‚¿ã‚¤ãƒˆãƒ« (push_strategy = pull_request ã®å ´åˆ)'
+        required: false
+        default: 'Apply multiple Codex patches'
+      pr_body:
+        description: 'PR æœ¬æ–‡ (ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆ)'
+        required: false
+        default: ''
+      fail_fast:
+        description: '1ã¤ã§ã‚‚ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ãŸã‚‰å³åº§ã«åœæ­¢ã™ã‚‹ã‹'
+        required: true
+        type: boolean
+        default: true
+      run_tests:
+        description: 'ãƒ‘ãƒƒãƒé©ç”¨å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹'
+        required: true
+        type: choice
+        default: 'skip'
+        options:
+          - skip
+          - run
+      test_command:
+        description: 'run_tests=run ã®å ´åˆã«å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰'
+        required: false
+        default: ''
+
+jobs:
+  apply-patches:
+    runs-on: ubuntu-latest
+    env:
+      PATCH_REPOSITORY: ${{ github.repository }}
+      TARGET_REPOSITORY: ${{ github.event.inputs.target_repository != '' && github.event.inputs.target_repository || github.repository }}
+      TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
+      PUSH_STRATEGY: ${{ github.event.inputs.push_strategy }}
+      COMMIT_MESSAGE: ${{ github.event.inputs.commit_message }}
+      FAIL_FAST: ${{ github.event.inputs.fail_fast }}
+      RUN_TESTS: ${{ github.event.inputs.run_tests }}
+      TEST_COMMAND: ${{ github.event.inputs.test_command }}
+    outputs:
+      patches_applied: ${{ steps.apply_patches.outputs.patches_applied }}
+      patches_failed: ${{ steps.apply_patches.outputs.patches_failed }}
+    steps:
+      - name: ãƒ‘ãƒƒãƒãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
+        uses: actions/checkout@v4
+        with:
+          fetch-depth: 0
+          path: patch-repo
+
+      - name: ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è§£æ
+        id: parse_patches
+        run: |
+          # æ”¹è¡Œã¾ãŸã¯ã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’é…åˆ—ã«å¤‰æ›
+          PATCH_INPUT="${{ github.event.inputs.patch_files }}"
+          
+          # æ”¹è¡Œã‚’ã‚«ãƒ³ãƒã«çµ±ä¸€
+          PATCH_INPUT=$(echo "$PATCH_INPUT" | tr '\n' ',')
+          
+          # é…åˆ—ã«å¤‰æ›ã—ã¦JSONå½¢å¼ã§ä¿å­˜
+          echo "$PATCH_INPUT" | tr ',' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))' > /tmp/patch_files.json
+          
+          echo "Patch files to apply:"
+          cat /tmp/patch_files.json
+          
+          PATCH_COUNT=$(jq 'length' /tmp/patch_files.json)
+          echo "patch_count=$PATCH_COUNT" >> "$GITHUB_OUTPUT"
+
+      - name: ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
+        run: |
+          cd "$GITHUB_WORKSPACE/patch-repo"
+          
+          MISSING_FILES=()
+          while IFS= read -r patch_file; do
+            if [ ! -f "$patch_file" ]; then
+              echo "::error::ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $patch_file"
+              MISSING_FILES+=("$patch_file")
+            else
+              echo "âœ“ ç¢ºèª: $patch_file"
+            fi
+          done < <(jq -r '.[]' /tmp/patch_files.json)
+          
+          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
+            echo "::error::ä»¥ä¸‹ã®ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:"
+            printf '%s\n' "${MISSING_FILES[@]}"
+            exit 1
+          fi
+
+      - name: å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª
+        if: env.TARGET_REPOSITORY != env.PATCH_REPOSITORY
+        env:
+          TOKEN_AVAILABLE: ${{ secrets.PATCH_APPLIER_TOKEN }}
+        run: |
+          if [ -z "$TOKEN_AVAILABLE" ]; then
+            echo "::error::target_repository ãŒåˆ¥ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯ PATCH_APPLIER_TOKEN ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã« repo ã‚¹ã‚³ãƒ¼ãƒ—ã® PAT ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚" >&2
+            exit 1
+          fi
+
+      - name: é©ç”¨å…ˆãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
+        uses: actions/checkout@v4
+        with:
+          repository: ${{ env.TARGET_REPOSITORY }}
+          ref: ${{ env.TARGET_BRANCH }}
+          fetch-depth: 0
+          path: target-repo
+          token: ${{ secrets.PATCH_APPLIER_TOKEN != '' && secrets.PATCH_APPLIER_TOKEN || github.token }}
+
+      - name: ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’æº–å‚™
+        id: prepare_branch
+        working-directory: target-repo
+        run: |
+          WORKING_BRANCH="$TARGET_BRANCH"
+          if [ "$PUSH_STRATEGY" = "pull_request" ]; then
+            WORKING_BRANCH="codex-batch-patch/${GITHUB_RUN_ID}"
+            git checkout -b "$WORKING_BRANCH"
+          fi
+          echo "branch=$WORKING_BRANCH" >> "$GITHUB_OUTPUT"
+
+      - name: ãƒ‘ãƒƒãƒã‚’é †æ¬¡é©ç”¨
+        id: apply_patches
+        working-directory: target-repo
+        run: |
+          PATCHES_APPLIED=0
+          PATCHES_FAILED=0
+          FAILED_PATCHES=()
+          
+          echo "=== ãƒ‘ãƒƒãƒé©ç”¨é–‹å§‹ ==="
+          echo ""
+          
+          while IFS= read -r patch_file; do
+            PATCH_PATH="$GITHUB_WORKSPACE/patch-repo/$patch_file"
+            
+            echo "----------------------------------------"
+            echo "ãƒ‘ãƒƒãƒã‚’é©ç”¨: $patch_file"
+            echo "----------------------------------------"
+            
+            # ãƒ‘ãƒƒãƒã®çµ±è¨ˆã‚’è¡¨ç¤º
+            if git apply --stat "$PATCH_PATH" 2>/dev/null; then
+              echo ""
+            fi
+            
+            # ãƒ‘ãƒƒãƒã‚’é©ç”¨
+            if git apply --apply --whitespace=fix "$PATCH_PATH" 2>&1; then
+              echo "âœ“ æˆåŠŸ: $patch_file"
+              PATCHES_APPLIED=$((PATCHES_APPLIED + 1))
+            else
+              echo "âœ— å¤±æ•—: $patch_file"
+              PATCHES_FAILED=$((PATCHES_FAILED + 1))
+              FAILED_PATCHES+=("$patch_file")
+              
+              if [ "$FAIL_FAST" = "true" ]; then
+                echo "::error::ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ: $patch_file"
+                echo "fail_fast ãŒæœ‰åŠ¹ãªãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™"
+                exit 1
+              fi
+            fi
+            
+            echo ""
+          done < <(jq -r '.[]' /tmp/patch_files.json)
+          
+          echo "=== ãƒ‘ãƒƒãƒé©ç”¨çµæœ ==="
+          echo "é©ç”¨æˆåŠŸ: $PATCHES_APPLIED"
+          echo "é©ç”¨å¤±æ•—: $PATCHES_FAILED"
+          
+          if [ $PATCHES_FAILED -gt 0 ]; then
+            echo ""
+            echo "å¤±æ•—ã—ãŸãƒ‘ãƒƒãƒ:"
+            printf '%s\n' "${FAILED_PATCHES[@]}"
+          fi
+          
+          echo "patches_applied=$PATCHES_APPLIED" >> "$GITHUB_OUTPUT"
+          echo "patches_failed=$PATCHES_FAILED" >> "$GITHUB_OUTPUT"
+          
+          if [ $PATCHES_FAILED -gt 0 ] && [ "$FAIL_FAST" = "false" ]; then
+            echo "::warning::ä¸€éƒ¨ã®ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã—ãŸ"
+          fi
+
+      - name: ä½œæ¥­ãƒ„ãƒªãƒ¼ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
+        working-directory: target-repo
+        run: |
+          echo "=== å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« ==="
+          git status --short
+          echo ""
+          echo "=== å¤‰æ›´ã®çµ±è¨ˆ ==="
+          git diff --stat
+
+      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
+        if: env.RUN_TESTS == 'run'
+        working-directory: target-repo
+        run: |
+          if [ -z "$TEST_COMMAND" ]; then
+            echo "::error::run_tests=run ã®å ´åˆã¯ test_command ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚" >&2
+            exit 1
+          fi
+          echo "ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ: $TEST_COMMAND"
+          eval "$TEST_COMMAND"
+
+      - name: ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆ
+        id: create_commit
+        working-directory: target-repo
+        run: |
+          if [ -z "$(git status --short)" ]; then
+            echo "has_changes=false" >> "$GITHUB_OUTPUT"
+            echo "ãƒ‘ãƒƒãƒé©ç”¨å¾Œã®å·®åˆ†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
+            exit 0
+          fi
+          
+          git config user.name "github-actions[bot]"
+          git config user.email "github-actions[bot]@users.noreply.github.com"
+          git add -A
+          
+          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é©ç”¨ã•ã‚ŒãŸãƒ‘ãƒƒãƒæƒ…å ±ã‚’è¿½åŠ 
+          COMMIT_MSG="$COMMIT_MESSAGE"$'\n\n'"Applied patches:"
+          
+          while IFS= read -r patch_file; do
+            COMMIT_MSG="$COMMIT_MSG"$'\n'"- $patch_file"
+          done < <(jq -r '.[]' /tmp/patch_files.json)
+          
+          COMMIT_MSG="$COMMIT_MSG"$'\n\n'"Patches applied: ${{ steps.apply_patches.outputs.patches_applied }}"
+          if [ "${{ steps.apply_patches.outputs.patches_failed }}" != "0" ]; then
+            COMMIT_MSG="$COMMIT_MSG"$'\n'"Patches failed: ${{ steps.apply_patches.outputs.patches_failed }}"
+          fi
+          
+          git commit -m "$COMMIT_MSG"
+          echo "has_changes=true" >> "$GITHUB_OUTPUT"
+
+      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
+        if: steps.create_commit.outputs.has_changes == 'true'
+        working-directory: target-repo
+        env:
+          PUSH_BRANCH: ${{ steps.prepare_branch.outputs.branch }}
+        run: git push origin HEAD:"$PUSH_BRANCH"
+
+      - name: Pull Request ã‚’ä½œæˆ
+        if: steps.create_commit.outputs.has_changes == 'true' && env.PUSH_STRATEGY == 'pull_request'
+        uses: actions/github-script@v7
+        with:
+          github-token: ${{ secrets.PATCH_APPLIER_TOKEN != '' && secrets.PATCH_APPLIER_TOKEN || github.token }}
+          script: |
+            const fs = require('fs');
+            const targetRepository = process.env.TARGET_REPOSITORY;
+            const [owner, repo] = targetRepository.split('/');
+            const base = process.env.TARGET_BRANCH;
+            const head = process.env.WORKING_BRANCH;
+            const prTitle = process.env.PR_TITLE || 'Apply multiple Codex patches';
+            const prBodyInput = process.env.PR_BODY_INPUT || '';
+            
+            // ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
+            const patchFiles = JSON.parse(fs.readFileSync('/tmp/patch_files.json', 'utf8'));
+            
+            const patchesList = patchFiles.map(f => `- \`${f}\``).join('\n');
+            
+            const defaultBody = [
+              '## ğŸ“¦ è¤‡æ•°ã®Codexãƒ‘ãƒƒãƒã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸ',
+              '',
+              '### é©ç”¨ã•ã‚ŒãŸãƒ‘ãƒƒãƒ',
+              patchesList,
+              '',
+              '### çµ±è¨ˆ',
+              `- é©ç”¨æˆåŠŸ: ${process.env.PATCHES_APPLIED}`,
+              `- é©ç”¨å¤±æ•—: ${process.env.PATCHES_FAILED}`,
+              '',
+              '### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿',
+              `- Patch repository: ${process.env.PATCH_REPOSITORY}`,
+              `- Base branch: ${base}`,
+              `- Head branch: ${head}`,
+              `- Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
+            ].join('\n');
+            
+            const body = prBodyInput.trim().length > 0 ? prBodyInput : defaultBody;
+            
+            // æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
+            const existing = await github.rest.pulls.list({
+              owner,
+              repo,
+              head: `${owner}:${head}`,
+              base,
+              state: 'open'
+            });
+            
+            if (existing.data.length > 0) {
+              core.info(`æ—¢å­˜ã® Pull Request ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${existing.data[0].html_url}`);
+              // PRæœ¬æ–‡ã‚’æ›´æ–°
+              await github.rest.pulls.update({
+                owner,
+                repo,
+                pull_number: existing.data[0].number,
+                body
+              });
+              return;
+            }
+            
+            // æ–°ã—ã„PRã‚’ä½œæˆ
+            const pr = await github.rest.pulls.create({
+              owner,
+              repo,
+              base,
+              head,
+              title: prTitle,
+              body
+            });
+            
+            core.info(`Pull Request created: ${pr.data.html_url}`);
+            core.setOutput('pr_url', pr.data.html_url);
+        env:
+          TARGET_REPOSITORY: ${{ env.TARGET_REPOSITORY }}
+          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
+          WORKING_BRANCH: ${{ steps.prepare_branch.outputs.branch }}
+          PATCH_REPOSITORY: ${{ env.PATCH_REPOSITORY }}
+          PR_TITLE: ${{ github.event.inputs.pr_title }}
+          PR_BODY_INPUT: ${{ github.event.inputs.pr_body }}
+          PATCHES_APPLIED: ${{ steps.apply_patches.outputs.patches_applied }}
+          PATCHES_FAILED: ${{ steps.apply_patches.outputs.patches_failed }}
+
+      - name: çµæœã‚µãƒãƒªãƒ¼
+        if: always()
+        run: |
+          echo "## ãƒ‘ãƒƒãƒé©ç”¨çµæœ" >> $GITHUB_STEP_SUMMARY
+          echo "" >> $GITHUB_STEP_SUMMARY
+          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
+          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
+          echo "| å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª | $TARGET_REPOSITORY |" >> $GITHUB_STEP_SUMMARY
+          echo "| å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ | $TARGET_BRANCH |" >> $GITHUB_STEP_SUMMARY
+          echo "| é©ç”¨æˆåŠŸ | ${{ steps.apply_patches.outputs.patches_applied }} |" >> $GITHUB_STEP_SUMMARY
+          echo "| é©ç”¨å¤±æ•— | ${{ steps.apply_patches.outputs.patches_failed }} |" >> $GITHUB_STEP_SUMMARY
+          echo "| ã‚³ãƒŸãƒƒãƒˆä½œæˆ | ${{ steps.create_commit.outputs.has_changes == 'true' && 'âœ“' || 'âœ—' }} |" >> $GITHUB_STEP_SUMMARY
diff --git a/.github/workflows/apply-codex-patch.yml b/.github/workflows/apply-codex-patch.yml
index 4ead1fb..e9b6962 100644
--- a/.github/workflows/apply-codex-patch.yml
+++ b/.github/workflows/apply-codex-patch.yml
@@ -3,163 +3,211 @@ name: Codexãƒ‘ãƒƒãƒé©ç”¨
 on:
   workflow_dispatch:
     inputs:
+      target_repository:
+        description: 'ãƒ‘ãƒƒãƒã‚’é©ç”¨ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª (owner/name)ã€‚ç©ºæ¬„æ™‚ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒª'
+        required: false
+        default: ''
       target_branch:
         description: 'ãƒ‘ãƒƒãƒã‚’é©ç”¨ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒå'
         required: true
         default: 'main'
-      source_branch:
-        description: 'ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒåï¼ˆçœç•¥æ™‚ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ãŸãƒ–ãƒ©ãƒ³ãƒï¼‰'
-        required: false
-        default: ''
       patch_file:
-        description: 'ãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ï¼ˆä¾‹: patchï¼‰'
+        description: 'patch-repo ã‹ã‚‰ã®ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç›¸å¯¾ãƒ‘ã‚¹ (ä¾‹: patches/whereabouts_TEST/index.patch)'
         required: true
         default: 'patch'
+      push_strategy:
+        description: 'direct: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ç›´æ¥ push / pull_request: ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ‡ã£ã¦ PR ä½œæˆ'
+        required: true
+        type: choice
+        default: 'pull_request'
+        options:
+          - pull_request
+          - direct
+      commit_message:
+        description: 'ä½œæˆã™ã‚‹ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
+        required: true
+        default: 'Apply Codex patch'
+      pr_title:
+        description: 'PR ã‚¿ã‚¤ãƒˆãƒ« (push_strategy = pull_request ã®å ´åˆ)'
+        required: false
+        default: 'Apply Codex patch'
+      pr_body:
+        description: 'PR æœ¬æ–‡ (ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆ)'
+        required: false
+        default: ''
+      run_tests:
+        description: 'ãƒ‘ãƒƒãƒé©ç”¨å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹'
+        required: true
+        type: choice
+        default: 'skip'
+        options:
+          - skip
+          - run
+      test_command:
+        description: 'run_tests=run ã®å ´åˆã«å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰'
+        required: false
+        default: ''
 
 jobs:
   apply-patch:
     runs-on: ubuntu-latest
-
+    env:
+      PATCH_REPOSITORY: ${{ github.repository }}
+      PATCH_FILE: ${{ github.event.inputs.patch_file }}
+      TARGET_REPOSITORY: ${{ github.event.inputs.target_repository != '' && github.event.inputs.target_repository || github.repository }}
+      TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
+      PUSH_STRATEGY: ${{ github.event.inputs.push_strategy }}
+      COMMIT_MESSAGE: ${{ github.event.inputs.commit_message }}
+      RUN_TESTS: ${{ github.event.inputs.run_tests }}
+      TEST_COMMAND: ${{ github.event.inputs.test_command }}
     steps:
-      - name: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
+      - name: ãƒ‘ãƒƒãƒã‚’å–å¾—
         uses: actions/checkout@v4
         with:
-          ref: ${{ github.event.inputs.target_branch }}
           fetch-depth: 0
+          path: patch-repo
 
-      - name: ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
-        env:
-          PATCH_FILE: ${{ github.event.inputs.patch_file }}
-          SOURCE_BRANCH_INPUT: ${{ github.event.inputs.source_branch }}
-          DEFAULT_SOURCE_BRANCH: ${{ github.ref_name }}
+      - name: ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
+        id: patch_file
         run: |
-          SOURCE_BRANCH="$SOURCE_BRANCH_INPUT"
-          if [ -z "$SOURCE_BRANCH" ]; then
-            SOURCE_BRANCH="$DEFAULT_SOURCE_BRANCH"
+          PATCH_PATH="$GITHUB_WORKSPACE/patch-repo/$PATCH_FILE"
+          if [ ! -f "$PATCH_PATH" ]; then
+            echo "::error::ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $PATCH_PATH" >&2
+            exit 1
           fi
+          echo "patch_path=$PATCH_PATH" >> "$GITHUB_OUTPUT"
 
-          SOURCE_BRANCH="${SOURCE_BRANCH#refs/heads/}"
-          SOURCE_BRANCH="${SOURCE_BRANCH#origin/}"
-
-          if ! git ls-remote --exit-code origin "refs/heads/$SOURCE_BRANCH" > /dev/null; then
-            echo "æŒ‡å®šã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ $SOURCE_BRANCH ãŒ origin ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚" >&2
+      - name: å¤–éƒ¨ãƒªãƒã‚¸ãƒˆãƒªç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª
+        if: env.TARGET_REPOSITORY != env.PATCH_REPOSITORY
+        env:
+          TOKEN_AVAILABLE: ${{ secrets.PATCH_APPLIER_TOKEN }}
+        run: |
+          if [ -z "$TOKEN_AVAILABLE" ]; then
+            echo "::error::target_repository ãŒåˆ¥ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯ PATCH_APPLIER_TOKEN ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã« repo ã‚¹ã‚³ãƒ¼ãƒ—ã® PAT ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚" >&2
             exit 1
           fi
 
-          git fetch origin "$SOURCE_BRANCH"
+      - name: é©ç”¨å…ˆãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
+        uses: actions/checkout@v4
+        with:
+          repository: ${{ env.TARGET_REPOSITORY }}
+          ref: ${{ env.TARGET_BRANCH }}
+          fetch-depth: 0
+          path: target-repo
+          token: ${{ secrets.PATCH_APPLIER_TOKEN != '' && secrets.PATCH_APPLIER_TOKEN || github.token }}
 
-          PATCH_PATH="$RUNNER_TEMP/codex.patch"
-          if ! git show "origin/$SOURCE_BRANCH:$PATCH_FILE" > "$PATCH_PATH"; then
-            echo "ãƒ–ãƒ©ãƒ³ãƒ $SOURCE_BRANCH ã« $PATCH_FILE ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚" >&2
-            exit 1
+      - name: ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’æº–å‚™
+        id: prepare_branch
+        working-directory: target-repo
+        run: |
+          WORKING_BRANCH="$TARGET_BRANCH"
+          if [ "$PUSH_STRATEGY" = "pull_request" ]; then
+            WORKING_BRANCH="codex-patch/${GITHUB_RUN_ID}"
+            git checkout -b "$WORKING_BRANCH"
           fi
-
-          echo "ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ $SOURCE_BRANCH ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸã€‚"
-          echo "SOURCE_BRANCH=$SOURCE_BRANCH" >> "$GITHUB_ENV"
-          echo "PATCH_PATH=$PATCH_PATH" >> "$GITHUB_ENV"
+          echo "branch=$WORKING_BRANCH" >> "$GITHUB_OUTPUT"
 
       - name: ãƒ‘ãƒƒãƒã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
+        working-directory: target-repo
         env:
-          PATCH_PATH: ${{ env.PATCH_PATH }}
+          PATCH_PATH: ${{ steps.patch_file.outputs.patch_path }}
         run: git apply --stat "$PATCH_PATH"
 
       - name: ãƒ‘ãƒƒãƒã‚’é©ç”¨
+        working-directory: target-repo
         env:
-          PATCH_PATH: ${{ env.PATCH_PATH }}
+          PATCH_PATH: ${{ steps.patch_file.outputs.patch_path }}
         run: git apply --apply --whitespace=fix "$PATCH_PATH"
 
       - name: ä½œæ¥­ãƒ„ãƒªãƒ¼ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
+        working-directory: target-repo
         run: git status --short
 
-      - name: Run tests (optional)
-        if: false
+      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
+        if: env.RUN_TESTS == 'run'
+        working-directory: target-repo
         run: |
-          echo "å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
+          if [ -z "$TEST_COMMAND" ]; then
+            echo "::error::run_tests=run ã®å ´åˆã¯ test_command ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚" >&2
+            exit 1
+          fi
+          eval "$TEST_COMMAND"
 
       - name: ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆ
+        id: create_commit
+        working-directory: target-repo
+        env:
+          COMMIT_MESSAGE: ${{ env.COMMIT_MESSAGE }}
         run: |
           if [ -z "$(git status --short)" ]; then
-            echo "HAS_CHANGES=false" >> "$GITHUB_ENV"
+            echo "has_changes=false" >> "$GITHUB_OUTPUT"
             echo "ãƒ‘ãƒƒãƒé©ç”¨å¾Œã®å·®åˆ†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
             exit 0
           fi
-          echo "HAS_CHANGES=true" >> "$GITHUB_ENV"
           git config user.name "github-actions"
           git config user.email "github-actions@github.com"
           git add -A
-          git commit -m "Apply Codex patch"
-
-      - name: ãƒ—ãƒƒã‚·ãƒ¥å…ˆãƒ–ãƒ©ãƒ³ãƒã‚’æ±ºå®š
-        if: env.HAS_CHANGES == 'true'
-        env:
-          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
-          DISPATCH_BRANCH: ${{ github.ref_name }}
-        run: |
-          PUSH_BRANCH="$TARGET_BRANCH"
-          if [ "$TARGET_BRANCH" != "$DISPATCH_BRANCH" ]; then
-            PUSH_BRANCH="codex-patch/${GITHUB_RUN_ID}"
-            echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ–ãƒ©ãƒ³ãƒãŒç•°ãªã‚‹ãŸã‚ã€$PUSH_BRANCH ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚"
-          else
-            echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã«ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚"
-          fi
-          echo "PUSH_BRANCH=$PUSH_BRANCH" >> "$GITHUB_ENV"
+          git commit -m "$COMMIT_MESSAGE"
+          echo "has_changes=true" >> "$GITHUB_OUTPUT"
 
       - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
-        if: env.HAS_CHANGES == 'true'
+        if: steps.create_commit.outputs.has_changes == 'true'
+        working-directory: target-repo
         env:
-          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
-          PUSH_BRANCH: ${{ env.PUSH_BRANCH }}
-        run: |
-          if [ "$PUSH_BRANCH" = "$TARGET_BRANCH" ]; then
-            if ! git show-ref --verify --quiet "refs/remotes/origin/$TARGET_BRANCH"; then
-              echo "æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒ $TARGET_BRANCH ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
-              exit 1
-            fi
-          fi
-          git push origin HEAD:"$PUSH_BRANCH"
+          PUSH_BRANCH: ${{ steps.prepare_branch.outputs.branch }}
+        run: git push origin HEAD:"$PUSH_BRANCH"
 
       - name: Pull Request ã‚’ä½œæˆ
-        if: env.HAS_CHANGES == 'true' && github.event.inputs.target_branch != github.ref_name
+        if: steps.create_commit.outputs.has_changes == 'true' && env.PUSH_STRATEGY == 'pull_request'
         uses: actions/github-script@v7
-        env:
-          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
-          SOURCE_BRANCH_FOR_PATCH: ${{ env.SOURCE_BRANCH }}
-          PATCH_FILE_PATH: ${{ github.event.inputs.patch_file }}
-          PUSH_BRANCH: ${{ env.PUSH_BRANCH }}
         with:
+          github-token: ${{ secrets.PATCH_APPLIER_TOKEN != '' && secrets.PATCH_APPLIER_TOKEN || github.token }}
           script: |
-            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
-            const headRef = `${owner}:${process.env.PUSH_BRANCH}`;
-            const baseRef = process.env.TARGET_BRANCH;
+            const targetRepository = process.env.TARGET_REPOSITORY;
+            const [owner, repo] = targetRepository.split('/');
+            const base = process.env.TARGET_BRANCH;
+            const head = process.env.WORKING_BRANCH;
+            const prTitle = process.env.PR_TITLE || 'Apply Codex patch';
+            const prBodyInput = process.env.PR_BODY_INPUT || '';
+
+            const defaultBody = [
+              'Codex ã§ç”Ÿæˆã•ã‚ŒãŸãƒ‘ãƒƒãƒã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸã€‚',
+              `- Patch repository: ${process.env.PATCH_REPOSITORY}`,
+              `- Patch file: ${process.env.PATCH_FILE}`,
+              `- Base branch: ${base}`,
+              `- Head branch: ${head}`
+            ].join('\n');
+
+            const body = prBodyInput.trim().length > 0 ? prBodyInput : defaultBody;
 
             const existing = await github.rest.pulls.list({
               owner,
               repo,
-              head: headRef,
-              base: baseRef,
+              head: `${owner}:${head}`,
+              base,
               state: 'open'
             });
 
             if (existing.data.length > 0) {
-              core.info(`æ—¢å­˜ã® Pull Request (${existing.data[0].html_url}) ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ–°è¦ä½œæˆã¯è¡Œã„ã¾ã›ã‚“ã€‚`);
+              core.info(`æ—¢å­˜ã® Pull Request ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${existing.data[0].html_url}`);
               return;
             }
 
-            const title = 'Apply Codex patch';
-            const body = [
-              'è‡ªå‹•é©ç”¨ã•ã‚ŒãŸ Codex ãƒ‘ãƒƒãƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
-              `- å…ƒãƒ–ãƒ©ãƒ³ãƒ: ${process.env.GITHUB_REF_NAME}`,
-              `- ãƒ‘ãƒƒãƒå–å¾—ãƒ–ãƒ©ãƒ³ãƒ: ${process.env.SOURCE_BRANCH_FOR_PATCH}`,
-              `- é©ç”¨ãƒ–ãƒ©ãƒ³ãƒ: ${baseRef}`,
-              `- ãƒ—ãƒƒã‚·ãƒ¥ãƒ–ãƒ©ãƒ³ãƒ: ${process.env.PUSH_BRANCH}`,
-              `- ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«: ${process.env.PATCH_FILE_PATH}`
-            ].join('\n');
-
-            await github.rest.pulls.create({
+            const pr = await github.rest.pulls.create({
               owner,
               repo,
-              title,
-              head: process.env.PUSH_BRANCH,
-              base: baseRef,
+              base,
+              head,
+              title: prTitle,
               body
             });
+
+            core.info(`Pull Request created: ${pr.data.html_url}`);
+        env:
+          TARGET_REPOSITORY: ${{ env.TARGET_REPOSITORY }}
+          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
+          WORKING_BRANCH: ${{ steps.prepare_branch.outputs.branch }}
+          PATCH_REPOSITORY: ${{ env.PATCH_REPOSITORY }}
+          PATCH_FILE: ${{ env.PATCH_FILE }}
+          PR_TITLE: ${{ github.event.inputs.pr_title }}
+          PR_BODY_INPUT: ${{ github.event.inputs.pr_body }}
